<!-- 
    CODENVY CONFIDENTIAL
    __________________

    [2012] - [2013] Codenvy, S.A.
    All Rights Reserved.

    NOTICE:  All information contained herein is, and remains
    the property of Codenvy S.A. and its suppliers,
    if any.  The intellectual and technical concepts contained
    herein are proprietary to Codenvy S.A.
    and its suppliers and may be covered by U.S. and Foreign Patents,
    patents in process, and are protected by trade secret or copyright law.
    Dissemination of this information or reproduction of this material
    is strictly forbidden unless prior written permission is obtained
    from Codenvy S.A..
 -->

<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" type="text/css" href="factory.css">
</head>
<body style="padding:0; margin:0; background:transparent;"></body>
	
<script type="text/javascript">

// URL to Factory JSON
var _factoryURL;

// Factory JSON
var _factoryJSON;

// Element which is used as a parent for Factory button
var _parent;

// URL to get count of acepted reequests
var _acceptedURL;

// Element which contains the number requests to create factory service 
var _accepted;

// Counter value
var _counterValue = 0;


/*
 *
 */
function getQueryParam(param){
    var search = window.location.search.substring(1);
    var array = search.split('&');
    for(var i = 0; i < array.length; i++){
        var pair = array[i].split('=');
        if(pair[0] == param){
            return pair[1];
        }
    }
}

function prepareFactoryURL() {
	var winUrl = window.location.href;
	_factoryURL = winUrl.substring(0, winUrl.lastIndexOf("//") + 2);
	winUrl = winUrl.substring(winUrl.lastIndexOf("//") + 2);
	_factoryURL += winUrl.split( '/' )[0] + "/api/factory/";
	
	var factoryID = getQueryParam("factory");
	_factoryURL += factoryID;
}

function loadFactoryJSON() {
	var request = new XMLHttpRequest();
	request.onreadystatechange  = function() {
		if (request.readyState == 4 && request.status == 200) {
			_factoryJSON = JSON.parse(request.responseText);
	        embedFactoryButton();
	    }
	}
	
	request.open("GET", _factoryURL, true);
	request.send();	
}

function update(width, height) {
	var message = "resize-factory-button:" + _factoryJSON.id + ":" + width + ":" + height;
	setTimeout(function() {
		parent.postMessage(message, "*");
	}, 10);
}

function getLink(rel) {
	for (i = 0; i < _factoryJSON.links.length; i++) {
		var linkObj = _factoryJSON.links[i];
		if (linkObj.rel == rel) {
			return linkObj.href;
		}
	}
	
	return null;
}

function factoryButtonClickHandler() {
	/*
	if (_accepted != null && _accepted != undefined) {
		_counterValue++;
		showAccepted();
	}
	*/
	
	var url = getLink("create-project");
	if (url == null || url == undefined || url.trim() == "") {
		return;
	}
	
	window.open(url, "_blank");
}

function embedWhite() {
	/*
		<div class="codenow-white"></div>
	*/

	var _embed = document.createElement("div");
    _embed.classList.add("codenow-white");
    _embed.onclick = factoryButtonClickHandler;
     _parent.appendChild(_embed);
}

function embedDark() {
	/*
		<div class="codenow-dark"></div>
	*/
	
	var _embed = document.createElement("div");
    _embed.classList.add("codenow-dark");
    _embed.onclick = factoryButtonClickHandler;
    _parent.appendChild(_embed);
}

function embedHorizontalWhite() {
	/*
		<div class="codenow-horizontal">
			<div class="codenow-white codenow-bottom"></div>
			<div class="codenow-counter-horizontal"><span>333</span></div>
		</div>
	*/

	var _embed = document.createElement("div");
    _embed.classList.add("codenow-horizontal");
    _parent.appendChild(_embed);
	
    var _button = document.createElement("div");
    _button.classList.add("codenow-white");
    _button.classList.add("codenow-bottom");
    _button.onclick = factoryButtonClickHandler;
    _embed.appendChild(_button);
    
    var _counter = document.createElement("div");
    _counter.classList.add("codenow-counter-horizontal");
    _embed.appendChild(_counter);
    
    _accepted = document.createElement("span");
    _counter.appendChild(_accepted);
}

function embedHorizontalDark() {
	/*
		<div class="codenow-horizontal">
			<div class="codenow-dark codenow-bottom"></div>
			<div class="codenow-counter-horizontal"><span>333</span></div>
		</div>
	*/
	
	var _embed = document.createElement("div");
    _embed.classList.add("codenow-horizontal");
    _parent.appendChild(_embed);

    var _button = document.createElement("div");
    _button.classList.add("codenow-dark");
    _button.classList.add("codenow-bottom");
    _button.onclick = factoryButtonClickHandler;
    _embed.appendChild(_button);

    var _counter = document.createElement("div");
    _counter.classList.add("codenow-counter-horizontal");
    _embed.appendChild(_counter);
    
    _accepted = document.createElement("span");
    _counter.appendChild(_accepted);    
}

function embedVerticalWhite() {
	/*
		<div class="codenow-vertical">
			<div class="codenow-counter-vertical"><span>333</span></div>
			<div class="codenow-white codenow-bottom"></div>
		</div>
	*/
	
	var _embed = document.createElement("div");
    _embed.classList.add("codenow-vertical");
    _parent.appendChild(_embed);
    
    var _counter = document.createElement("div");
    _counter.classList.add("codenow-counter-vertical");
    _embed.appendChild(_counter);

    _accepted = document.createElement("span");
    _counter.appendChild(_accepted);    
    
    var _button = document.createElement("div");
    _button.classList.add("codenow-white");
    _button.classList.add("codenow-bottom");
    _button.onclick = factoryButtonClickHandler;
    _embed.appendChild(_button);		
}

function embedVerticalDark() {
	/*
		<div class="codenow-vertical">
			<div class="codenow-counter-vertical"><span>333</span></div>
			<div class="codenow-dark codenow-bottom"></div>
		</div>
	*/

	var _embed = document.createElement("div");
    _embed.classList.add("codenow-vertical");
    _parent.appendChild(_embed);

    var _counter = document.createElement("div");
    _counter.classList.add("codenow-counter-vertical");
    _embed.appendChild(_counter);		
    
    _accepted = document.createElement("span");
    _counter.appendChild(_accepted);

    var _button = document.createElement("div");
    _button.classList.add("codenow-dark");
    _button.classList.add("codenow-bottom");
    _button.onclick = factoryButtonClickHandler;
    _embed.appendChild(_button);
}

function embedAdvanced() {
	/*
		<div class="advanced-factory">
			<img alt="" src="..." />
			<div></div>
		</div>
	*/

	var _logoURL = getLink("image");
	
	var _embed = document.createElement("div");
    _embed.classList.add("advanced-factory");
    _parent.appendChild(_embed);
    
    _logoImage = document.createElement("img");
    _logoImage.src = _logoURL;
    _logoImage.style.opacity = 0;
    
    _logoImage.onload = function(e) {
    	e.target.style.opacity = 1;
    }
    
    _logoImage.onerror = function(e) {
    	e.target.style.opacity = 1;
    	e.target.classList.add("advanced-factory-no-logo-available");
    }

    _logoImage.onabort = _logoImage.onerror;    
    _embed.appendChild(_logoImage);
    	    
    var _button = document.createElement("div");
    _button.onclick = factoryButtonClickHandler;
    _embed.appendChild(_button);

    if (_logoURL == null || "" == _logoURL) {	    	
    	logoLoadError();
    }	    
}

function embedAdvancedWithCounter() {
	/*
		<div class="advanced-factory-noted">
			<img alt="" src="..." />
			<div></div>
			<span>33</span>
		</div>
	*/

	var _logoURL = getLink("image");
	
	var _embed = document.createElement("div");
	_embed.classList.add("advanced-factory-noted");
	_parent.appendChild(_embed);
	
	_logoImage = document.createElement("img");
	_logoImage.src = _logoURL;
	_logoImage.style.opacity = 0;
	
	_logoImage.onload = function(e) {
		e.target.style.opacity = 1;
	}
	
	_logoImage.onerror = function(e) {
		e.target.style.opacity = 1;
		e.target.classList.add("advanced-factory-no-logo-available");
	}
	
	_logoImage.onabort = _logoImage.onerror;    
	_embed.appendChild(_logoImage);
		    
	var _button = document.createElement("div");
	_button.onclick = factoryButtonClickHandler;
	_embed.appendChild(_button);
	
    _accepted = document.createElement("span");
    _embed.appendChild(_accepted);	
	
	if (_logoURL == null || "" == _logoURL) {	    	
		logoLoadError();
	}	    
}

function isDigits(s) {
	var r=/^\d+$/;
	return r.test(s);
}

function showAccepted() {
	_accepted.innerHTML = "0";
	try {
		var acceptedURL = getLink("accepted");
		if (acceptedURL == null || acceptedURL == undefined) {
			return;
		}

		var request = new XMLHttpRequest();
		request.onreadystatechange  = function() {
			if (request.readyState == 4 && request.status == 200) {
				if (isDigits(request.responseText)) {
					_accepted.innerHTML = request.responseText;
				} else {
					_accepted.innerHTML = "0";
				}				
		    }
		}

		request.open("GET", acceptedURL, true);
		request.send();	
	} catch (e) {
		console.log("" + e.message);
	}
}

function embedFactoryButton() {
	switch (_factoryJSON.style) {
		
		case "White":
			embedWhite();
			update(77, 21);
			break;
			
		case "Dark":
			embedDark();
			update(77, 21);
			break;
			
		case "Horizontal,White":
			embedHorizontalWhite();
			update(118, 21);
			break;
			
		case "Horizontal,Dark":
			embedHorizontalDark();
			update(118, 21);
			break;
			
		case "Vertical,White":
			embedVerticalWhite();
			update(77, 61);
			break;
			
		case "Vertical,Dark":
			embedVerticalDark();
			update(77, 61);
			break;
			
		case "Advanced":
			embedAdvanced();
			update(112, 113);
			break;
			
		case "Advanced with Counter":
			embedAdvancedWithCounter();
			update(112, 113);
			break;

		default:
			console.log("Invalid button style");
	}
	
	if (_accepted != null && _accepted != undefined) {
		_counterValue = 0;
		showAccepted();
	}
	
}

_parent = document.body;

prepareFactoryURL();

loadFactoryJSON();

</script>
	
</html>
