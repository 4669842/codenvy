# plugin webhooks

Handle webhook events and update Codenvy factories accordingly.

## Concepts
* GitHub Webhook: List of factories mapped to a GitHub repository. These factories each contain a project with source.location = given repository. These factories (in fact matching project in them) will be updated when events for the given GitHub repository are received.
* Connector: Represents a connection to a third-party service where Codenvy factory URL will be displayed. Currently Jenkins connector is available.

## GitHub webhooks
Two type of GitHub events are processed:
* Push event: If a webhook is configured for event.repository and if in this webhook a factory is listed that contains a project with location = event.repository and branch = event.branch then check if URL of this factory is present on configured connectors (third-party services) and if not add it.
* Pull Request event: If a webhook is configured for event.baseRepository and if in this webhook a factory is listed that contains a project with location = event.headRepository and branch = event.headBranch then update this project with location = event.baseRepository, commitId = event.headCommitId and clean branch parameter if set.

#### Configure
* `/home/codenvy/github-webhooks.properties`: List of GitHub webhooks.
* `/home/codenvy/connectors.properties`: List of configured connectors.
* `/home/codenvy/credentials.properties`: username and password used to authenticate against Codenvy.

1. On GitHub go to https://github.com/{user}/{repository}/settings/hooks and configure a new webhook for the repository. Set the 'api/github-webhook' URL of your Codenvy instance (example: http://internal.codenvycorp.com/api/github-webhook).
2. Create factories for your repository (or let them be generated by [Codenvy JIRA add-on](https://github.com/codenvy/codenvy-jira-addon)).
3. On your Codenvy instance, make sure that webhook, connector and credentials properties files are ready.
4. Let's work on your feature branch, push changes and finally merge your branch.
5. Factories related to your repository and branch will stay up to date with your last contributions. If connectors where configured your third-party services will always show up to date Codenvy factories.

## Microsoft VSTS webhooks
Two type of VSTS events are processed:
* Work Item created event: If a webhook and a parent factory are configured for a VSTS Team Project and VSTS credentials (provided as part of the webhook) are correct then generate Develop and Review factories for the work item and push factories link to VSTS extension storage.
* Pull Request merged event

#### Configure
* `/home/codenvy/vsts-webhooks.properties`: List of VSTS webhooks.
* `/home/codenvy/credentials.properties`: username and password used to authenticate against Codenvy.

1. On VSTS go to https://{account}.visualstudio.com/DefaultCollection/{project-name}/_admin/_servicehooks and configure a new webhook for 'Work item created' events. Set the 'api/vsts-webhook' URL of your Codenvy instance (example: http://internal.codenvycorp.com/api/vsts-webhook).
2. On your Codenvy instance, make sure that webhook and credentials properties files are ready. In particular VSTS credentials given as part of the webhook are secondary credentials generated as described [here](https://www.visualstudio.com/en-us/integrate/get-started/auth/overview).
3. Create parent factory for the Team Project. The parent factory must be named same as the Team Project and created by same Codenvy user as specified in `credentials.properties`.
4. Create a new Work Item on the VSTS Team Project.
5. Open the work item and click _Developer Workspace_ or _Reviewer Workspace_ to open related factories. You can check new factories on Codenvy dashboard too.

Examples of properties files can be found in [test resources](codenvy-plugin-github-server/src/test/resources).
